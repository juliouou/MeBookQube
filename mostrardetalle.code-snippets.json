{"generator":"Code Snippets v3.9.3","date_created":"2026-01-19 13:12","snippets":[{"id":7,"name":"MostrarDetalle","code":"add_shortcode('mebook_detalle_libro', 'funcion_detalle_compra_final');\n\nfunction funcion_detalle_compra_final() {\n    global $wpdb;\n    $libro_id = isset($_GET['id_libro']) ? intval($_GET['id_libro']) : 0;\n    $libro = $wpdb->get_row($wpdb->prepare(\"SELECT * FROM libros WHERE id = %d\", $libro_id));\n\n    if (!$libro) return \"<div class='p-10 text-center'>Libro no encontrado<\/div>\";\n\n    $current_user = wp_get_current_user();\n    $mensaje = '';\n\n    \/\/ L\u00d3GICA DE COMPRA\n    if (isset($_POST['accion_comprar']) && is_user_logged_in()) {\n        $precio = floatval($libro->precio);\n        $vendedor_id = $libro->usuario_id;\n        $comprador_id = $current_user->ID;\n\n        if ($libro->disponibilidad != 'disponible') {\n            $mensaje = \"<div class='bg-red-100 text-red-700 p-4 rounded mb-4'>\u274c \u00a1Este libro ya fue vendido!<\/div>\";\n        } elseif ($vendedor_id == $comprador_id) {\n            $mensaje = \"<div class='bg-yellow-100 text-yellow-700 p-4 rounded mb-4'>\u26a0\ufe0f No puedes comprar tu propio libro.<\/div>\";\n        } else {\n            $saldo_comprador = (float) get_user_meta($comprador_id, 'mycred_default', true);\n            \n            if ($saldo_comprador >= $precio) {\n                update_user_meta($comprador_id, 'mycred_default', $saldo_comprador - $precio);\n                $saldo_vendedor = (float) get_user_meta($vendedor_id, 'mycred_default', true);\n                update_user_meta($vendedor_id, 'mycred_default', $saldo_vendedor + $precio);\n                $wpdb->update('libros', array('disponibilidad' => 'vendido', 'comprador_id' => $comprador_id), array('id' => $libro_id));\n                $libro->disponibilidad = 'vendido';\n                $mensaje = \"<div class='bg-green-100 text-green-700 p-4 rounded mb-4 border border-green-400'>\ud83c\udf89 \u00a1Compra exitosa!<\/div>\";\n            } else {\n                $mensaje = \"<div class='bg-red-100 text-red-700 p-4 rounded mb-4'>\u274c Saldo insuficiente.<\/div>\";\n            }\n        }\n    }\n\n    \/\/ DATOS VISUALES\n    $vendedor = get_userdata($libro->usuario_id);\n    $nombre_vendedor = $vendedor ? $vendedor->display_name : 'Desconocido';\n    \n    \/\/ Parche imagen libro\n    $img_final = $libro->imagen;\n    if ( strpos($img_final, 'wp-content') !== false ) {\n        $partes = explode('\/wp-content\/', $img_final);\n        if ( count($partes) > 1 ) $img_final = get_home_url() . '\/wp-content\/' . $partes[1];\n    }\n\n    \/\/ Avatar vendedor\n    $foto_vendedor = get_user_meta($libro->usuario_id, 'mebook_avatar_custom', true);\n    $avatar_vendedor = $foto_vendedor ? $foto_vendedor : 'https:\/\/www.gravatar.com\/avatar\/?d=mp&s=200';\n\n    ob_start();\n    ?>\n    <script src=\"https:\/\/cdn.tailwindcss.com\"><\/script>\n    <link href=\"https:\/\/fonts.googleapis.com\/css2?family=Lexend:wght@300;400;500;600;700&display=swap\" rel=\"stylesheet\"\/>\n\n    <div class=\"max-w-6xl mx-auto p-6 font-['Lexend']\">\n        <?php echo $mensaje; ?>\n        \n        <div class=\"bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row\">\n            <div class=\"md:w-1\/2 bg-gray-100 p-8 flex items-center justify-center\">\n                <img src=\"<?php echo esc_url($img_final); ?>\" class=\"max-h-[500px] shadow-2xl rounded-lg\">\n            <\/div>\n\n            <div class=\"md:w-1\/2 p-8 md:p-12 flex flex-col\">\n                <div class=\"flex justify-between items-start\">\n                    <span class=\"bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full uppercase\">\n                        <?php echo esc_html($libro->estado); ?>\n                    <\/span>\n                    <span class=\"text-gray-400 text-sm\"><?php echo date('d\/m\/Y', strtotime($libro->fecha_publicacion)); ?><\/span>\n                <\/div>\n\n                <h1 class=\"text-4xl font-bold text-[#101817] mt-4 mb-2\"><?php echo esc_html($libro->titulo); ?><\/h1>\n                <p class=\"text-xl text-gray-500 mb-6 font-light\"><?php echo esc_html($libro->autor); ?><\/p>\n\n                <div class=\"flex items-center gap-2 mb-8\">\n                    <span class=\"text-4xl font-bold text-[#004c42]\">\ud83d\udc8e <?php echo number_format($libro->precio, 0); ?><\/span>\n                <\/div>\n\n                <div class=\"flex items-center gap-4 p-4 bg-gray-50 rounded-xl mb-8 border border-gray-100\">\n                    <img src=\"<?php echo esc_url($avatar_vendedor); ?>\" class=\"w-12 h-12 rounded-full object-cover\">\n                    <div class=\"flex-1\">\n                        <p class=\"text-xs text-gray-500 uppercase font-bold\">Vendido por<\/p>\n                        <a href=\"<?php echo home_url('\/perfil-de-usuario\/?id='.$libro->usuario_id); ?>\" class=\"text-[#004c42] font-bold hover:underline text-lg\">\n                            <?php echo esc_html($nombre_vendedor); ?>\n                        <\/a>\n                    <\/div>\n                    <\/div>\n\n                <div class=\"mb-8\">\n                    <h3 class=\"font-bold text-lg mb-2\">Sinopsis<\/h3>\n                    <p class=\"text-gray-600 leading-relaxed\"><?php echo nl2br(esc_html($libro->descripcion)); ?><\/p>\n                <\/div>\n\n                <div class=\"mt-auto pt-6 border-t border-gray-100 flex gap-4\">\n                    <?php if ($libro->disponibilidad == 'disponible'): ?>\n                        <form method=\"post\" class=\"flex-1\">\n                            <button type=\"submit\" name=\"accion_comprar\" class=\"w-full bg-[#004c42] hover:bg-[#003831] text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2\" onclick=\"return confirm('\u00bfConfirmar compra por <?php echo $libro->precio; ?> MeBokies?');\">\n                                <span>\ud83d\uded2 Comprar Ahora<\/span>\n                            <\/button>\n                        <\/form>\n                    <?php else: ?>\n                        <div class=\"w-full bg-gray-200 text-gray-500 font-bold py-4 rounded-xl text-center cursor-not-allowed\">\n                            \ud83d\udeab Vendido\n                        <\/div>\n                    <?php endif; ?>\n                <\/div>\n\n                <?php if (!is_user_logged_in()): ?>\n                    <p class=\"text-center text-red-500 text-sm mt-4\">Inicia sesi\u00f3n para comprar.<\/p>\n                <?php endif; ?>\n            <\/div>\n        <\/div>\n    <\/div>\n    <?php\n    return ob_get_clean();\n}","active":true,"modified":"2026-01-14 03:06:54","revision":"1"}]}