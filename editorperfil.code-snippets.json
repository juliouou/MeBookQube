{"generator":"Code Snippets v3.9.3","date_created":"2026-01-19 13:12","snippets":[{"id":18,"name":"EditorPerfil","code":"add_shortcode( 'mebook_onboarding', 'funcion_onboarding_perfil_final_v3' );\n\nfunction funcion_onboarding_perfil_final_v3() {\n    \n    if ( !is_user_logged_in() ) return '<script>window.location.href=\"'.home_url().'\";<\/script>';\n\n    $current_user = wp_get_current_user();\n    $user_id = $current_user->ID;\n\n    \/\/ --- 1. PROCESAR GUARDADO ---\n    if ( isset($_POST['mebook_onboarding_nonce']) && wp_verify_nonce($_POST['mebook_onboarding_nonce'], 'guardar_perfil') ) {\n        \n        $nombre_raw   = sanitize_text_field($_POST['nombre']);\n        $apellido_raw = sanitize_text_field($_POST['apellido']);\n        $bio_raw      = $_POST['bio'];\n\n        \/\/ === \ud83d\udee1\ufe0f ZONA DE SEGURIDAD (DATOS) ===\n        $patron_nombres = \"\/^[a-zA-Z\\s\u00f1\u00d1\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00fc\u00dc]+$\/\";\n        if ( !preg_match($patron_nombres, $nombre_raw) || !preg_match($patron_nombres, $apellido_raw) ) {\n            echo '<script>alert(\"\u274c Error: Los nombres solo pueden contener letras.\"); window.history.back();<\/script>';\n            exit;\n        }\n\n        if ( $bio_raw !== strip_tags($bio_raw) ) {\n            echo '<script>alert(\"\u26a0\ufe0f Error: No se permite c\u00f3digo HTML en la biograf\u00eda.\"); window.history.back();<\/script>';\n            exit;\n        }\n        $bio_final = sanitize_textarea_field($bio_raw);\n\n        \/\/ Guardar Textos\n        update_user_meta( $user_id, 'first_name', $nombre_raw );\n        update_user_meta( $user_id, 'last_name', $apellido_raw );\n        update_user_meta( $user_id, 'description', $bio_final );\n        $intereses = isset($_POST['intereses']) ? $_POST['intereses'] : array();\n        update_user_meta( $user_id, 'mebook_intereses', $intereses );\n        wp_update_user( array( 'ID' => $user_id, 'display_name' => $nombre_raw . ' ' . $apellido_raw ) );\n\n        \/\/ === \ud83d\udcf8 ZONA DE IM\u00c1GENES (OPTIMIZACI\u00d3N) ===\n        if ( !empty($_FILES['foto_perfil']['name']) ) {\n            \n            \/\/ 1. Validar Peso M\u00e1ximo (5MB) antes de procesar\n            if ( $_FILES['foto_perfil']['size'] > 5 * 1024 * 1024 ) {\n                echo '<script>alert(\"\u274c La imagen es demasiado pesada (M\u00e1x 5MB).\"); window.history.back();<\/script>';\n                exit;\n            }\n\n            if ( !function_exists('wp_handle_upload') ) require_once( ABSPATH . 'wp-admin\/includes\/file.php' );\n            $uploadedfile = $_FILES['foto_perfil'];\n            $upload_overrides = array( 'test_form' => false );\n            \n            \/\/ Subir archivo original\n            $movefile = wp_handle_upload( $uploadedfile, $upload_overrides );\n\n            if ( $movefile && !isset( $movefile['error'] ) ) {\n                \n                \/\/ --- INICIO OPTIMIZACI\u00d3N ---\n                $archivo_ruta = $movefile['file'];\n                \n                \/\/ Cargar el editor de imagen de WordPress\n                $image_editor = wp_get_image_editor( $archivo_ruta );\n                \n                if ( !is_wp_error( $image_editor ) ) {\n                    \/\/ A. Redimensionar (M\u00e1ximo 800x800 p\u00edxeles)\n                    $image_editor->resize( 800, 800, false );\n                    \n                    \/\/ B. Comprimir (Calidad 80%)\n                    $image_editor->set_quality( 80 );\n                    \n                    \/\/ C. Guardar (Sobrescribir el archivo original)\n                    $image_editor->save( $archivo_ruta );\n                }\n                \/\/ --- FIN OPTIMIZACI\u00d3N ---\n\n                update_user_meta( $user_id, 'mebook_avatar_custom', $movefile['url'] );\n            }\n        }\n\n        \/\/ Redirecci\u00f3n final\n        echo '<script>alert(\"\u2705 Perfil guardado con \u00e9xito.\"); window.location.href=\"'.home_url('\/mi-cuenta').'\";<\/script>';\n        exit;\n    }\n\n    \/\/ --- 2. RECUPERAR DATOS (VISUAL) ---\n    $nombre_previo   = get_user_meta($user_id, 'first_name', true);\n    $apellido_previo = get_user_meta($user_id, 'last_name', true);\n    $bio_previa      = get_user_meta($user_id, 'description', true);\n    $intereses_previos = get_user_meta($user_id, 'mebook_intereses', true);\n    if(!is_array($intereses_previos)) $intereses_previos = array();\n    \n    $foto_custom = get_user_meta($user_id, 'mebook_avatar_custom', true);\n    $avatar_mostrar = $foto_custom ? $foto_custom : 'https:\/\/www.gravatar.com\/avatar\/?d=mp&s=200';\n\n    ob_start();\n    ?>\n    <script src=\"https:\/\/cdn.tailwindcss.com\"><\/script>\n    <link href=\"https:\/\/fonts.googleapis.com\/css2?family=Lexend:wght@300;400;500;600&display=swap\" rel=\"stylesheet\"\/>\n    \n    <div class=\"min-h-screen bg-[#f5f8f8] flex items-center justify-center p-4 font-['Lexend']\">\n        <div class=\"bg-white max-w-2xl w-full rounded-2xl shadow-xl border border-gray-100 overflow-hidden\">\n            \n            <div class=\"bg-[#004c42] p-8 text-center relative\">\n                <h1 class=\"text-2xl font-bold text-white mb-1\">Editar Perfil \u270f\ufe0f<\/h1>\n                <p class=\"text-green-100 text-sm\">Personaliza c\u00f3mo te ven los dem\u00e1s en MEBOOK.<\/p>\n            <\/div>\n\n            <form method=\"post\" enctype=\"multipart\/form-data\" class=\"p-8 space-y-6\">\n                <?php wp_nonce_field('guardar_perfil', 'mebook_onboarding_nonce'); ?>\n\n                <div class=\"flex flex-col items-center gap-4\">\n                    <div class=\"relative group\">\n                        <img src=\"<?php echo esc_url($avatar_mostrar); ?>\" class=\"w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg\">\n                        <label class=\"absolute bottom-0 right-0 bg-[#004c42] text-white p-2 rounded-full cursor-pointer hover:bg-[#003831] shadow-md transition-all\">\n                            <span class=\"material-symbols-outlined text-sm\">\ud83d\udcf7<\/span>\n                            <input type=\"file\" name=\"foto_perfil\" accept=\"image\/*\" class=\"hidden\">\n                        <\/label>\n                    <\/div>\n                    <p class=\"text-xs text-gray-400\">Se optimizar\u00e1 autom\u00e1ticamente.<\/p>\n                <\/div>\n\n                <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <div>\n                        <label class=\"block text-sm font-bold text-gray-700 mb-2\">Nombre<\/label>\n                        <input type=\"text\" name=\"nombre\" value=\"<?php echo esc_attr($nombre_previo); ?>\" required pattern=\"[a-zA-Z\\s\u00f1\u00d1\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00fc\u00dc]+\" title=\"Solo letras.\" class=\"w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#004c42] invalid:border-red-500\">\n                    <\/div>\n                    <div>\n                        <label class=\"block text-sm font-bold text-gray-700 mb-2\">Apellido<\/label>\n                        <input type=\"text\" name=\"apellido\" value=\"<?php echo esc_attr($apellido_previo); ?>\" required pattern=\"[a-zA-Z\\s\u00f1\u00d1\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00fc\u00dc]+\" title=\"Solo letras.\" class=\"w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#004c42] invalid:border-red-500\">\n                    <\/div>\n                <\/div>\n\n                <div>\n                    <label class=\"block text-sm font-bold text-gray-700 mb-2\">Bio<\/label>\n                    <textarea name=\"bio\" rows=\"3\" class=\"w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#004c42]\"><?php echo esc_textarea($bio_previa); ?><\/textarea>\n                <\/div>\n\n                <div>\n                    <label class=\"block text-sm font-bold text-gray-700 mb-3\">Intereses<\/label>\n                    <div class=\"grid grid-cols-2 md:grid-cols-3 gap-3\">\n                        <?php \n                        $cats = ['Novela', 'Ciencia Ficci\u00f3n', 'Acad\u00e9mico', 'Infantil', 'Terror', 'Romance', 'Manga', 'Historia', 'Negocios'];\n                        foreach($cats as $cat): \n                            $checked = in_array($cat, $intereses_previos) ? 'checked' : '';\n                        ?>\n                        <label class=\"cursor-pointer relative\">\n                            <input type=\"checkbox\" name=\"intereses[]\" value=\"<?php echo $cat; ?>\" <?php echo $checked; ?> class=\"peer sr-only\">\n                            <div class=\"w-full p-3 text-sm border rounded-xl hover:bg-gray-50 peer-checked:bg-[#e0f2f1] peer-checked:border-[#004c42] peer-checked:text-[#004c42] transition-all text-center\">\n                                <?php echo $cat; ?>\n                            <\/div>\n                        <\/label>\n                        <?php endforeach; ?>\n                    <\/div>\n                <\/div>\n\n                <button type=\"submit\" class=\"w-full bg-[#004c42] hover:bg-[#003831] text-white font-bold py-4 rounded-xl shadow-lg transition-all\">\n                    Guardar Cambios\n                <\/button>\n            <\/form>\n        <\/div>\n    <\/div>\n    <?php\n    return ob_get_clean();\n}","active":true,"modified":"2026-01-14 14:21:16","revision":"1"}]}