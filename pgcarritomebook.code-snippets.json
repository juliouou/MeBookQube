{"generator":"Code Snippets v3.9.3","date_created":"2026-01-19 13:12","snippets":[{"id":9,"name":"PgCarritoMeBook","code":"add_shortcode( 'mebook_ver_carrito', 'funcion_pagina_carrito' );\n\nfunction funcion_pagina_carrito() {\n    global $wpdb;\n    $user_id = get_current_user_id();\n    $items = $_SESSION['mebook_carrito'];\n\n    \/\/ --- PROCESAR PAGO FINAL ---\n    if ( isset($_POST['pagar_todo_carrito']) && !empty($items) ) {\n        if ( ! is_user_logged_in() ) return '<p class=\"alerta-error\">Inicia sesi\u00f3n para pagar.<\/p>';\n        \n        \/\/ Calcular total real de nuevo (seguridad)\n        $ids_placeholder = implode(',', array_map('intval', $items));\n        $libros_db = $wpdb->get_results( \"SELECT * FROM libros WHERE id IN ($ids_placeholder)\" );\n        \n        $total_pagar = 0;\n        foreach($libros_db as $l) $total_pagar += $l->precio;\n\n        \/\/ Verificar saldo\n        if ( function_exists( 'mycred_get_users_balance' ) ) {\n            $saldo = mycred_get_users_balance( $user_id );\n            \n            if ( $saldo >= $total_pagar ) {\n                \/\/ PROCEDER AL PAGO DE CADA LIBRO\n                foreach ( $libros_db as $libro ) {\n                    \/\/ 1. Cobrar al comprador\n                    mycred_subtract( 'compra_libro', $user_id, $libro->precio, \"Compra Carrito: Libro #{$libro->id}\" );\n                    \/\/ 2. Pagar al vendedor\n                    mycred_add( 'venta_libro', $libro->usuario_id, $libro->precio, \"Venta Carrito: Libro #{$libro->id}\" );\n                    \/\/ 3. Marcar vendido (Opcional: cambiar estado)\n                    \/\/ $wpdb->update('libros', array('estado' => 'Vendido'), array('id' => $libro->id));\n                }\n                \n                \/\/ Vaciar carrito y \u00e9xito\n                $_SESSION['mebook_carrito'] = array();\n                return '<div class=\"alerta-exito\">\ud83c\udf89 <strong>\u00a1COMPRA REALIZADA!<\/strong><br>Has gastado '.$total_pagar.' MeBokies.<br>Revisa tus notificaciones.<\/div>';\n            \n            } else {\n                return '<div class=\"alerta-error\">\u274c No tienes saldo suficiente. Total: '.$total_pagar.' - Tienes: '.$saldo.'<\/div>';\n            }\n        }\n    }\n\n    \/\/ --- MOSTRAR TABLA ---\n    if ( empty( $items ) ) {\n        return '<div style=\"text-align:center; padding:50px;\"><h3>Tu carrito est\u00e1 vac\u00edo \ud83d\uded2<\/h3><a href=\"'.home_url('\/tienda').'\" class=\"btn-volver\">Ir a la Tienda<\/a><\/div>';\n    }\n\n    \/\/ Traer detalles de los libros en el carrito\n    $ids_placeholder = implode(',', array_map('intval', $items));\n    $libros = $wpdb->get_results( \"SELECT * FROM libros WHERE id IN ($ids_placeholder)\" );\n    $total = 0;\n\n    ob_start();\n    ?>\n    <style>\n        .tabla-carrito { width: 100%; border-collapse: collapse; margin-bottom: 20px; }\n        .tabla-carrito th { background: #f4f4f4; padding: 10px; text-align: left; }\n        .tabla-carrito td { border-bottom: 1px solid #eee; padding: 10px; }\n        .total-box { background: #002B5B; color: white; padding: 20px; border-radius: 10px; text-align: right; }\n        .btn-pagar-todo { background: #28a745; color: white; padding: 10px 30px; border: none; font-size: 18px; cursor: pointer; border-radius: 5px; }\n        .btn-borrar { color: red; text-decoration: none; font-weight: bold; }\n    <\/style>\n\n    <h2>Tu Carrito de Libros<\/h2>\n    <table class=\"tabla-carrito\">\n        <thead>\n            <tr>\n                <th>Libro<\/th>\n                <th>Vendedor<\/th>\n                <th>Precio<\/th>\n                <th>Acci\u00f3n<\/th>\n            <\/tr>\n        <\/thead>\n        <tbody>\n            <?php foreach ( $libros as $libro ) : \n                $total += $libro->precio;\n                $vendedor = get_userdata($libro->usuario_id);\n                $nombre_vendedor = $vendedor ? $vendedor->display_name : 'Desconocido';\n            ?>\n            <tr>\n                <td>\n                    <img src=\"<?php echo esc_url($libro->imagen); ?>\" style=\"width:50px; height:70px; object-fit:cover; vertical-align:middle; margin-right:10px;\">\n                    <strong><?php echo esc_html($libro->titulo); ?><\/strong>\n                <\/td>\n                <td><?php echo esc_html($nombre_vendedor); ?><\/td>\n                <td><?php echo esc_html($libro->precio); ?> \ud83d\udc8e<\/td>\n                <td><a href=\"?borrar_item=<?php echo $libro->id; ?>\" class=\"btn-borrar\">\ud83d\uddd1\ufe0f Quitar<\/a><\/td>\n            <\/tr>\n            <?php endforeach; ?>\n        <\/tbody>\n    <\/table>\n\n    <div class=\"total-box\">\n        <h3>Total a Pagar: <?php echo $total; ?> MeBokies \ud83d\udc8e<\/h3>\n        <form method=\"post\">\n            <input type=\"hidden\" name=\"pagar_todo_carrito\" value=\"1\">\n            <button type=\"submit\" class=\"btn-pagar-todo\" onclick=\"return confirm('\u00bfPagar <?php echo $total; ?> MeBokies por estos libros?')\">\u2705 Finalizar Compra<\/button>\n        <\/form>\n    <\/div>\n    \n    <div style=\"margin-top:20px;\">\n        <form method=\"post\"><button name=\"vaciar_carrito\" class=\"btn-borrar\" style=\"background:none; border:none; cursor:pointer;\">Vaciar todo el carrito<\/button><\/form>\n    <\/div>\n\n    <?php\n    return ob_get_clean();\n}","active":true,"modified":"2025-12-16 00:33:12","revision":"1"}]}