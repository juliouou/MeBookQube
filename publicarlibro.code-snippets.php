{"generator":"Code Snippets v3.9.3","date_created":"2026-01-19 13:12","snippets":[{"id":16,"name":"publicarLibro","code":"add_shortcode( 'mebook_publicar_premium', 'funcion_publicar_libro_premium_v4_full' );\n\nfunction funcion_publicar_libro_premium_v4_full() {\n    \n    \/\/ 1. LOGIN GATE (Usando el panel unificado)\n    if ( !is_user_logged_in() ) {\n        if ( function_exists('mebook_render_login_register_panel') ) {\n            return mebook_render_login_register_panel();\n        } else {\n            return '<div class=\"text-center p-10 font-bold text-gray-500\">\ud83d\udd12 Inicia sesi\u00f3n para vender.<\/div>';\n        }\n    }\n\n    $mensaje_estado = '';\n    \n    \/\/ 2. PROCESAR FORMULARIO\n    if ( isset($_POST['titulo_libro']) && wp_verify_nonce($_POST['mebook_publicar_nonce'], 'publicar_libro_accion') ) {\n        \n        global $wpdb;\n        $current_user = wp_get_current_user();\n\n        \/\/ Sanitizaci\u00f3n\n        $titulo = sanitize_text_field($_POST['titulo_libro']);\n        $autor  = sanitize_text_field($_POST['autor_libro']);\n        $precio = floatval($_POST['precio_libro']);\n        $estado = sanitize_text_field($_POST['estado_libro']);\n        $desc   = sanitize_textarea_field($_POST['descripcion_libro']);\n        \n        \/\/ Categor\u00edas\n        $cats_raw = isset($_POST['cats_libro']) ? $_POST['cats_libro'] : array();\n        $cats_str = implode(', ', array_map('sanitize_text_field', $cats_raw));\n\n        \/\/ === \ud83d\udcf8 PROCESAMIENTO DE PORTADA (OPTIMIZADA) ===\n        $imagen_url = '';\n        $error_imagen = false;\n\n        if ( !empty($_FILES['portada_libro']['name']) ) {\n            \n            \/\/ A. Validar Peso (5MB)\n            if ( $_FILES['portada_libro']['size'] > 5 * 1024 * 1024 ) {\n                 $mensaje_estado = '<div class=\"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm\"><p class=\"font-bold\">\u274c Error: Imagen muy pesada (M\u00e1x 5MB).<\/p><\/div>';\n                 $error_imagen = true;\n            } \n            \n            if ( !$error_imagen ) {\n                if ( !function_exists('wp_handle_upload') ) require_once( ABSPATH . 'wp-admin\/includes\/file.php' );\n                $uploadedfile = $_FILES['portada_libro'];\n                $upload_overrides = array( 'test_form' => false );\n                \n                $movefile = wp_handle_upload( $uploadedfile, $upload_overrides );\n\n                if ( $movefile && !isset( $movefile['error'] ) ) {\n                    $imagen_url = $movefile['url'];\n                    $archivo_ruta = $movefile['file'];\n\n                    \/\/ --- INICIO OPTIMIZACI\u00d3N ---\n                    $image_editor = wp_get_image_editor( $archivo_ruta );\n                    if ( !is_wp_error( $image_editor ) ) {\n                        \/\/ Redimensionar a 800x1200 (Formato Vertical Libro)\n                        $image_editor->resize( 800, 1200, false );\n                        \/\/ Calidad 80% (HD Web)\n                        $image_editor->set_quality( 80 );\n                        $image_editor->save( $archivo_ruta );\n                    }\n                    \/\/ --- FIN OPTIMIZACI\u00d3N ---\n\n                } else {\n                     $mensaje_estado = '<div class=\"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6\"><p>Error al subir imagen.<\/p><\/div>';\n                     $error_imagen = true;\n                }\n            }\n        }\n\n        \/\/ Insertar en BD\n        if ( !$error_imagen ) {\n            $insertado = $wpdb->insert('libros', array(\n                'usuario_id'  => $current_user->ID,\n                'titulo'      => $titulo,\n                'autor'       => $autor,\n                'categorias'  => $cats_str,\n                'descripcion' => $desc,\n                'estado'      => $estado,\n                'precio'      => $precio,\n                'imagen'      => $imagen_url,\n                'disponibilidad' => 'disponible'\n            ));\n\n            if($insertado) {\n                echo '<script>alert(\"\u2705 \u00a1Libro publicado con \u00e9xito!\"); window.location.href=\"'.home_url('\/tienda').'\";<\/script>';\n                exit;\n            } else {\n                $mensaje_estado = '<div class=\"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6\"><p class=\"font-bold\">\u274c Error de Base de Datos<\/p><\/div>';\n            }\n        }\n    }\n    \n    \/\/ 3. HTML DEL FORMULARIO\n    ob_start();\n    ?>\n    <script src=\"https:\/\/cdn.tailwindcss.com\"><\/script>\n    <link href=\"https:\/\/fonts.googleapis.com\/css2?family=Lexend:wght@300;400;500;600;700&display=swap\" rel=\"stylesheet\"\/>\n\n    <div class=\"min-h-screen bg-[#f5f8f8] py-12 px-4 font-['Lexend']\">\n        <div class=\"max-w-4xl mx-auto\">\n            \n            <div class=\"text-center mb-12\">\n                <h1 class=\"text-4xl font-bold text-[#004c42] mb-4\">Publicar un Libro \ud83d\udcda<\/h1>\n                <p class=\"text-xl text-gray-600 max-w-2xl mx-auto\">Vende tus libros usados en Loja.<\/p>\n            <\/div>\n\n            <?php echo $mensaje_estado; ?>\n\n            <div class=\"bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100\">\n                <div class=\"flex flex-col md:flex-row\">\n                    \n                    <div class=\"md:w-2\/3 p-8 md:p-12 relative z-10\">\n                        <form method=\"post\" enctype=\"multipart\/form-data\" class=\"space-y-8\">\n                            <?php wp_nonce_field('publicar_libro_accion', 'mebook_publicar_nonce'); ?>\n                            \n                            <div class=\"grid grid-cols-1 gap-6\">\n                                <div>\n                                    <label class=\"block text-sm font-bold text-gray-700 mb-2\">T\u00edtulo del Libro <span class=\"text-red-500\">*<\/span><\/label>\n                                    <input type=\"text\" name=\"titulo_libro\" required class=\"w-full px-4 py-4 rounded-2xl border-2 border-gray-100 focus:border-[#004c42] bg-gray-50 focus:bg-white outline-none font-bold text-gray-800\" placeholder=\"Ej: Cien A\u00f1os de Soledad\">\n                                <\/div>\n                                <div>\n                                    <label class=\"block text-sm font-bold text-gray-700 mb-2\">Autor <span class=\"text-red-500\">*<\/span><\/label>\n                                    <input type=\"text\" name=\"autor_libro\" required class=\"w-full px-4 py-4 rounded-2xl border-2 border-gray-100 focus:border-[#004c42] bg-gray-50 focus:bg-white outline-none font-medium\" placeholder=\"Ej: Gabriel Garc\u00eda M\u00e1rquez\">\n                                <\/div>\n                            <\/div>\n\n                            <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-2xl border border-gray-100\">\n                                <div>\n                                    <label class=\"block text-sm font-bold text-gray-700 mb-2\">Precio (MeBokies) <span class=\"text-red-500\">*<\/span><\/label>\n                                    <div class=\"relative\">\n                                        <span class=\"absolute left-4 top-1\/2 transform -translate-y-1\/2 text-xl\">\ud83d\udc8e<\/span>\n                                        <input type=\"number\" name=\"precio_libro\" required min=\"1\" step=\"0.01\" class=\"w-full pl-12 pr-4 py-4 rounded-xl border-2 border-white focus:border-[#004c42] outline-none font-bold text-lg shadow-sm\" placeholder=\"0\">\n                                    <\/div>\n                                <\/div>\n                                <div>\n                                    <label class=\"block text-sm font-bold text-gray-700 mb-2\">Estado <span class=\"text-red-500\">*<\/span><\/label>\n                                    <select name=\"estado_libro\" class=\"w-full px-4 py-4 rounded-xl border-2 border-white focus:border-[#004c42] outline-none font-medium bg-white shadow-sm\">\n                                        <option value=\"Bueno\" selected>\ud83d\udc4d Bueno<\/option>\n                                        <option value=\"Nuevo\">\u2728 Nuevo<\/option>\n                                        <option value=\"Como Nuevo\">\ud83d\udc4c Como Nuevo<\/option>\n                                        <option value=\"Usado\">\ud83d\udcd6 Usado<\/option>\n                                    <\/select>\n                                <\/div>\n                            <\/div>\n\n                            <div>\n                                <label class=\"block text-sm font-bold text-gray-700 mb-4\">Categor\u00edas<\/label>\n                                <div class=\"grid grid-cols-2 sm:grid-cols-3 gap-3\">\n                                    <?php $cats_opts = ['Novela', 'Ciencia Ficci\u00f3n', 'Fantas\u00eda', 'Acad\u00e9mico', 'Infantil', 'Terror', 'Romance', 'Manga', 'Historia', 'Negocios'];\n                                    foreach($cats_opts as $cat): ?>\n                                    <label class=\"cursor-pointer relative\">\n                                        <input type=\"checkbox\" name=\"cats_libro[]\" value=\"<?php echo $cat; ?>\" class=\"peer sr-only\">\n                                        <div class=\"w-full p-2 text-xs md:text-sm border rounded-xl hover:bg-green-50 peer-checked:bg-[#004c42] peer-checked:text-white peer-checked:border-[#004c42] transition-all text-center select-none\">\n                                            <?php echo $cat; ?>\n                                        <\/div>\n                                    <\/label>\n                                    <?php endforeach; ?>\n                                <\/div>\n                            <\/div>\n\n                            <div>\n                                <label class=\"block text-sm font-bold text-gray-700 mb-2\">Descripci\u00f3n<\/label>\n                                <textarea name=\"descripcion_libro\" rows=\"4\" required class=\"w-full px-4 py-4 rounded-2xl border-2 border-gray-100 focus:border-[#004c42] bg-gray-50 focus:bg-white outline-none resize-none\" placeholder=\"Sinopsis, detalles del estado, etc...\"><\/textarea>\n                            <\/div>\n\n                            <button type=\"submit\" class=\"w-full bg-[#004c42] hover:bg-[#003831] text-white font-bold py-5 rounded-2xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3 text-lg\">\n                                <span>\ud83d\ude80 Publicar Libro Ahora<\/span>\n                            <\/button>\n\n                        <\/form>\n                    <\/div>\n\n                    <div class=\"md:w-1\/3 bg-[#004c42] p-8 md:p-12 text-white flex flex-col justify-center items-center text-center relative overflow-hidden\">\n                        <div class=\"relative z-10 w-full\">\n                            <h3 class=\"text-2xl font-bold mb-2\">La Portada<\/h3>\n                            <p class=\"text-green-100 text-sm mb-8\">Sube una foto clara. M\u00e1ximo 5MB.<\/p>\n\n                            <label class=\"block w-full aspect-[2\/3] border-4 border-dashed border-green-400\/50 rounded-2xl hover:bg-white\/10 transition-all cursor-pointer flex flex-col items-center justify-center group relative overflow-hidden\" id=\"drop-area\">\n                                \n                                <img id=\"preview-img\" class=\"absolute inset-0 w-full h-full object-cover hidden rounded-xl\">\n\n                                <div class=\"group-hover:scale-110 transition-transform duration-300\" id=\"upload-icon\">\n                                    <span class=\"material-symbols-outlined text-6xl mb-2 text-green-200\">add_a_photo<\/span>\n                                    <p class=\"font-bold text-sm text-green-200\">Clic para subir<\/p>\n                                <\/div>\n                                \n                                <input type=\"file\" name=\"portada_libro\" accept=\"image\/*\" class=\"hidden\" onchange=\"mostrarPrevia(this)\">\n                            <\/label>\n                        <\/div>\n                    <\/div>\n\n                <\/div>\n            <\/div>\n        <\/div>\n    <\/div>\n\n    <script>\n    function mostrarPrevia(input) {\n        if (input.files && input.files[0]) {\n            var reader = new FileReader();\n            reader.onload = function(e) {\n                document.getElementById('preview-img').src = e.target.result;\n                document.getElementById('preview-img').classList.remove('hidden');\n                document.getElementById('upload-icon').classList.add('opacity-0');\n            }\n            reader.readAsDataURL(input.files[0]);\n        }\n    }\n    <\/script>\n    <?php\n    return ob_get_clean();\n}","active":true,"modified":"2026-01-14 14:20:08","revision":"1"}]}
