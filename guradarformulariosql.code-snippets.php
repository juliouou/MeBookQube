{"generator":"Code Snippets v3.9.3","date_created":"2026-01-19 13:11","snippets":[{"id":6,"name":"GuradarFormularioSQL","code":"add_action( 'elementor_pro\/forms\/new_record', 'mebook_guardar_corregido_final', 10, 2 );\n\nfunction mebook_guardar_corregido_final( $record, $handler ) {\n    \/\/ 1. Validar nombre del formulario\n    $form_name = $record->get_form_settings( 'form_name' );\n    if ( 'formulario_publicar_libro' !== $form_name ) {\n        return;\n    }\n\n    \/\/ 2. Obtener Usuario (Modo Seguro)\n    $user_id = get_current_user_id();\n    if ( $user_id == 0 ) {\n        \/\/ Si no detecta usuario, lo asignamos al Admin (ID 1) para no perder el libro\n        $user_id = 1; \n    }\n\n    \/\/ 3. Obtener datos del formulario\n    $raw_fields = $record->get( 'fields' );\n    $fields = [];\n    foreach ( $raw_fields as $id => $field ) {\n        $fields[ $id ] = $field['value'];\n    }\n\n    \/\/ Procesar Imagen\n    $url_imagen = '';\n    if ( ! empty( $fields['imagen'] ) ) {\n        $url_imagen = is_array($fields['imagen']) && isset($fields['imagen']['url']) ? $fields['imagen']['url'] : $fields['imagen'];\n    }\n\n    \/\/ 4. GUARDAR EN BASE DE DATOS (Nombres corregidos seg\u00fan tu imagen)\n    global $wpdb;\n    \n    \/\/ Validar campos vac\u00edos para evitar errores\n    $titulo = !empty($fields['titulo']) ? $fields['titulo'] : 'Sin T\u00edtulo';\n    $autor = !empty($fields['autor']) ? $fields['autor'] : 'An\u00f3nimo';\n    $desc = !empty($fields['descripcion']) ? $fields['descripcion'] : '';\n    $cat = !empty($fields['categoria']) ? $fields['categoria'] : 'General';\n    $estado = !empty($fields['estado']) ? $fields['estado'] : 'Nuevo';\n    $precio = !empty($fields['precio']) ? $fields['precio'] : 0;\n\n    $resultado = $wpdb->insert(\n        'libros', \n        array(\n            'titulo'      => $titulo,\n            'autor'       => $autor,\n            'categorias'  => $cat,   \/\/ <--- \u00a1AQU\u00cd ESTABA EL ERROR! (Ahora es Plural)\n            'descripcion' => $desc,\n            'precio'      => $precio,\n            'estado'      => $estado,\n            'imagen'      => $url_imagen,\n            'usuario_id'  => $user_id\n        ),\n        array( '%s', '%s', '%s', '%s', '%d', '%s', '%s', '%d' )\n    );\n\n    \/\/ 5. Verificar si hubo error\n    if ( $resultado === false ) {\n        $handler->add_error_message( \"\ud83d\udea8 Error SQL: \" . $wpdb->last_error );\n        $handler->is_success = false;\n    }\n}","active":true,"modified":"2025-12-10 15:07:56","revision":"1"}]}
